"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.PackageJsonHelper = exports.PackageJsonC = exports.addJsonPackageSmScript = exports.patchJsonPackage = exports.retrieveJsonPackage = void 0;
const t = __importStar(require("io-ts"));
const Either_1 = require("fp-ts/Either");
const paths_1 = require("./paths");
const files_1 = __importDefault(require("./files"));
const consts_1 = require("../consts");
function retrieveJsonPackage(cwd) {
    const pkgPath = (0, paths_1.JsonPackagePath)(cwd);
    if (!files_1.default.exists(pkgPath)) {
        return {
            exists: false,
            content: null,
        };
    }
    const content = files_1.default.safeReadJson(pkgPath);
    return {
        exists: true,
        content,
    };
}
exports.retrieveJsonPackage = retrieveJsonPackage;
function patchJsonPackage(cwd, data) {
    const pkg = retrieveJsonPackage(cwd);
    if (!pkg.exists || !pkg.content)
        return false;
    const updatedPkg = {
        ...pkg.content,
        ...data,
    };
    files_1.default.write((0, paths_1.JsonPackagePath)(cwd), updatedPkg, { recursive: false });
    return true;
}
exports.patchJsonPackage = patchJsonPackage;
function addJsonPackageSmScript(cwd) {
    const pkg = retrieveJsonPackage(cwd);
    if (!pkg.exists || !pkg.content)
        return false;
    const { scripts = {} } = pkg.content;
    if (scripts[consts_1.SCRIPT_NAME])
        return false;
    return patchJsonPackage(cwd, {
        scripts: { ...scripts, [consts_1.SCRIPT_NAME]: consts_1.SCRIPT_VALUE },
    });
}
exports.addJsonPackageSmScript = addJsonPackageSmScript;
exports.PackageJsonC = t.exact(t.partial({
    name: t.union([t.string, t.void]),
    dependencies: t.record(t.string, t.string),
}));
exports.PackageJsonHelper = {
    fromPath(pkgPath) {
        return files_1.default.readEntity(pkgPath, (payload) => {
            return (0, Either_1.getOrElseW)(() => new Error(`Unable to decode package.json`))(exports.PackageJsonC.decode(payload));
        });
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGtnLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL25vZGUtdXRpbHMvcGtnLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSx5Q0FBMkI7QUFDM0IseUNBQTBDO0FBQzFDLG1DQUF1RDtBQUN2RCxvREFBNEI7QUFFNUIsc0NBQXNEO0FBSXRELFNBQWdCLG1CQUFtQixDQUFDLEdBQVc7SUFDN0MsTUFBTSxPQUFPLEdBQUcsSUFBQSx1QkFBZSxFQUFDLEdBQUcsQ0FBQyxDQUFDO0lBRXJDLElBQUksQ0FBQyxlQUFLLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQzFCLE9BQU87WUFDTCxNQUFNLEVBQUUsS0FBSztZQUNiLE9BQU8sRUFBRSxJQUFJO1NBQ2QsQ0FBQztLQUNIO0lBRUQsTUFBTSxPQUFPLEdBQXVCLGVBQUssQ0FBQyxZQUFZLENBQ3BELE9BQU8sQ0FDYyxDQUFDO0lBQ3hCLE9BQU87UUFDTCxNQUFNLEVBQUUsSUFBSTtRQUNaLE9BQU87S0FDUixDQUFDO0FBQ0osQ0FBQztBQWpCRCxrREFpQkM7QUFFRCxTQUFnQixnQkFBZ0IsQ0FDOUIsR0FBVyxFQUNYLElBQTBCO0lBRTFCLE1BQU0sR0FBRyxHQUE2QixtQkFBbUIsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMvRCxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPO1FBQUUsT0FBTyxLQUFLLENBQUM7SUFFOUMsTUFBTSxVQUFVLEdBQUc7UUFDakIsR0FBRyxHQUFHLENBQUMsT0FBTztRQUNkLEdBQUcsSUFBSTtLQUNSLENBQUM7SUFFRixlQUFLLENBQUMsS0FBSyxDQUFDLElBQUEsdUJBQWUsRUFBQyxHQUFHLENBQUMsRUFBRSxVQUFVLEVBQUUsRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUNwRSxPQUFPLElBQUksQ0FBQztBQUNkLENBQUM7QUFkRCw0Q0FjQztBQUVELFNBQWdCLHNCQUFzQixDQUFDLEdBQVc7SUFDaEQsTUFBTSxHQUFHLEdBQUcsbUJBQW1CLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDckMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTztRQUFFLE9BQU8sS0FBSyxDQUFDO0lBRTlDLE1BQU0sRUFBRSxPQUFPLEdBQUcsRUFBRSxFQUFFLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQztJQUVyQyxJQUFJLE9BQU8sQ0FBQyxvQkFBVyxDQUFDO1FBQUUsT0FBTyxLQUFLLENBQUM7SUFFdkMsT0FBTyxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUU7UUFDM0IsT0FBTyxFQUFFLEVBQUUsR0FBRyxPQUFPLEVBQUUsQ0FBQyxvQkFBVyxDQUFDLEVBQUUscUJBQVksRUFBRTtLQUNyRCxDQUFDLENBQUM7QUFDTCxDQUFDO0FBWEQsd0RBV0M7QUFHWSxRQUFBLFlBQVksR0FBRyxDQUFDLENBQUMsS0FBSyxDQUNqQyxDQUFDLENBQUMsT0FBTyxDQUFDO0lBQ1IsSUFBSSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNqQyxZQUFZLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUM7Q0FDM0MsQ0FBQyxDQUNILENBQUM7QUFJVyxRQUFBLGlCQUFpQixHQUFHO0lBQy9CLFFBQVEsQ0FBQyxPQUFlO1FBQ3RCLE9BQU8sZUFBSyxDQUFDLFVBQVUsQ0FBZSxPQUFPLEVBQUUsQ0FBQyxPQUFnQixFQUFFLEVBQUU7WUFDbEUsT0FBTyxJQUFBLG1CQUFVLEVBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxLQUFLLENBQUMsK0JBQStCLENBQUMsQ0FBQyxDQUNqRSxvQkFBWSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FDN0IsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGLENBQUMifQ==