"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getComponentInfo = void 0;
const path_1 = __importDefault(require("path"));
const Either_1 = require("fp-ts/lib/Either");
const screenshot_1 = require("./screenshot");
const files_1 = __importDefault(require("../node-utils/files"));
const mocks_1 = require("./mocks");
const Slice_1 = require("../models/Slice");
const errors_1 = __importDefault(require("../utils/errors"));
const slices_1 = require("@prismicio/types-internal/lib/customtypes/widgets/slices");
function getComponentName(slicePath) {
    const split = slicePath.split(path_1.default.sep);
    const pop = split.pop();
    if (!pop)
        return;
    if (pop.indexOf("index.") === 0) {
        return split.pop();
    }
    if (pop.indexOf(split[split.length - 1]) === 0) {
        return slicePath.split(path_1.default.sep).pop();
    }
    return pop.split(".")[0];
}
function findComponentFile(files, componentName) {
    const possiblePaths = ["index", componentName].reduce((acc, f) => [
        ...acc,
        `${f}.vue`,
        `${f}.js`,
        `${f}.jsx`,
        `${f}.ts`,
        `${f}.tsx`,
        `${f}.svelte`,
    ], []);
    return files.find((e) => possiblePaths.indexOf(e) > -1);
}
function matchPossiblePaths(files) {
    const modelFilename = "model.json";
    return files.includes(modelFilename);
}
function splitExtension(str) {
    const fullName = str.split("/").pop();
    if (!fullName) {
        return {
            fileName: null,
            extension: null,
        };
    }
    const [fileName, extension] = fullName.split(".");
    return {
        fileName,
        extension,
    };
}
function fromJsonFile(pathToFile, validate) {
    const fullPath = path_1.default.join(pathToFile);
    const hasFile = files_1.default.exists(fullPath);
    if (hasFile) {
        return files_1.default.readEntity(fullPath, validate);
    }
    return null;
}
function getFileInfoFromPath(slicePath, componentName) {
    const isDirectory = files_1.default.isDirectory(slicePath);
    if (!isDirectory) {
        return { ...splitExtension(slicePath) };
    }
    const files = files_1.default.readDirectory(slicePath);
    const match = matchPossiblePaths(files);
    if (match) {
        const maybeFileComponent = findComponentFile(files, componentName);
        if (maybeFileComponent) {
            return { ...splitExtension(maybeFileComponent) };
        }
        return { fileName: null, extension: null };
    }
    throw new Error(`[slice-machine] Could not find module file for component "${componentName}" at path "${slicePath}"`);
}
function getComponentInfo(slicePath, assetsPaths, from) {
    const sliceName = getComponentName(slicePath);
    if (!sliceName || !sliceName.length) {
        console.error(`[queries/component-info] Could not find slice name at path "${slicePath}". Skipping...`);
        return;
    }
    const fileInfo = (() => {
        try {
            return getFileInfoFromPath(slicePath, sliceName);
        }
        catch (e) {
            return null;
        }
    })();
    if (fileInfo === null) {
        return;
    }
    const { fileName, extension } = fileInfo;
    const model = fromJsonFile(path_1.default.join(slicePath, "model.json"), (payload) => (0, Either_1.getOrElseW)((e) => new Error(errors_1.default.report(e)))(slices_1.SharedSlice.decode(payload)));
    if (!model) {
        return;
    }
    if (model instanceof Error) {
        console.error(`Could not parse model ${path_1.default.basename(slicePath)}\nFull error: ${model.toString()}`);
        return;
    }
    const smModel = Slice_1.Slices.toSM(model);
    const screenshotPaths = (smModel.variations || [])
        .map((v) => {
        const activeScreenshot = (0, screenshot_1.resolvePathsToScreenshot)({
            paths: assetsPaths,
            from,
            sliceName,
            variationId: v.id,
        });
        return activeScreenshot && { [v.id]: activeScreenshot };
    })
        .reduce((acc, variationPreview) => {
        return { ...acc, ...variationPreview };
    }, {});
    const maybeMock = (0, mocks_1.resolvePathsToMock)({
        paths: assetsPaths,
        from,
        sliceName,
    });
    return {
        fileName,
        extension,
        model: smModel,
        mock: maybeMock === null || maybeMock === void 0 ? void 0 : maybeMock.value,
        screenshotPaths,
    };
}
exports.getComponentInfo = getComponentInfo;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2xpYnJhcmllcy9jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsZ0RBQXdCO0FBRXhCLDZDQUE4QztBQUk5Qyw2Q0FBd0Q7QUFDeEQsZ0VBQXdDO0FBQ3hDLG1DQUE2QztBQUM3QywyQ0FBc0Q7QUFFdEQsNkRBQXFDO0FBQ3JDLHFGQUF1RjtBQUd2RixTQUFTLGdCQUFnQixDQUFDLFNBQWlCO0lBQ3pDLE1BQU0sS0FBSyxHQUFHLFNBQVMsQ0FBQyxLQUFLLENBQUMsY0FBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3hDLE1BQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUN4QixJQUFJLENBQUMsR0FBRztRQUFFLE9BQU87SUFFakIsSUFBSSxHQUFHLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRTtRQUMvQixPQUFPLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQztLQUNwQjtJQUNELElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsRUFBRTtRQUM5QyxPQUFPLFNBQVMsQ0FBQyxLQUFLLENBQUMsY0FBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDO0tBQ3hDO0lBQ0QsT0FBTyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzNCLENBQUM7QUFHRCxTQUFTLGlCQUFpQixDQUN4QixLQUE0QixFQUM1QixhQUFxQjtJQUVyQixNQUFNLGFBQWEsR0FBRyxDQUFDLE9BQU8sRUFBRSxhQUFhLENBQUMsQ0FBQyxNQUFNLENBQ25ELENBQUMsR0FBYSxFQUFFLENBQVMsRUFBRSxFQUFFLENBQUM7UUFDNUIsR0FBRyxHQUFHO1FBQ04sR0FB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