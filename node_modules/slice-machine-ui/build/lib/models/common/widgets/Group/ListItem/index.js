"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const react_1 = require("react");
const react_beautiful_dnd_1 = require("react-beautiful-dnd");
const theme_ui_1 = require("theme-ui");
const utils_1 = require("@lib/utils");
const str_1 = require("@utils/str");
const SelectFieldTypeModal_1 = __importDefault(require("@lib/builders/common/SelectFieldTypeModal"));
const NewField_1 = __importDefault(require("@lib/builders/common/Zone/Card/components/NewField"));
const EditModal_1 = __importDefault(require("@lib/builders/common/EditModal"));
const utils_2 = require("@builders/utils");
const Widgets = __importStar(require("@lib/models/common/widgets"));
const MockConfig_1 = require("@lib/models/common/MockConfig");
const sliceBuilderArray_1 = __importDefault(require("@lib/models/common/widgets/sliceBuilderArray"));
const Hints_1 = __importDefault(require("@lib/builders/common/Zone/Card/components/Hints"));
const ListItem_1 = __importDefault(require("@components/ListItem"));
const CustomListItem = ({ tabId, store, Model, widget, parentSnapshot, framework, showHints, isRepeatable, item: groupItem, draggableId, renderFieldAccessor, ...rest }) => {
    const [selectMode, setSelectMode] = react_1.useState(false);
    const [newFieldData, setNewFieldData] = react_1.useState(null);
    const [editModalData, setEditModalData] = react_1.useState({ isOpen: false });
    const onSelectFieldType = (widgetTypeName) => {
        setNewFieldData({ widgetTypeName });
        setSelectMode(false);
    };
    const getFieldMockConfig = ({ apiId }) => {
        return MockConfig_1.CustomTypeMockConfig.getFieldMockConfig(Model.mockConfig, apiId);
    };
    const onCancelNewField = () => {
        setNewFieldData(null);
    };
    const closeEditModal = () => {
        setEditModalData({ isOpen: false });
    };
    const onSaveNewField = ({ id, widgetTypeName }) => {
        const widget = Widgets[widgetTypeName];
        store.tab(tabId).group(groupItem.key).addWidget(id, widget.create(id));
    };
    const onSaveField = ({ apiId: previousKey, newKey, value, mockValue }) => {
        if (utils_1.ensureWidgetTypeExistence(Widgets, value.type)) {
            return;
        }
        if (mockValue) {
            store.updateWidgetGroupMockConfig(Model.mockConfig, groupItem.key, previousKey, newKey, mockValue);
        }
        else {
            store.deleteWidgetGroupMockConfig(Model.mockConfig, groupItem.key, previousKey);
        }
        store
            .tab(tabId)
            .group(groupItem.key)
            .replaceWidget(previousKey, newKey, value);
    };
    const onDragEnd = (result) => {
        if (utils_1.ensureDnDDestination(result)) {
            return;
        }
        store
            .tab(tabId)
            .group(groupItem.key)
            .reorderWidget(result.source.index, result.destination.index);
    };
    const onDeleteItem = (key) => {
        store.deleteWidgetGroupMockConfig(Model.mockConfig, groupItem.key, key);
        store.tab(tabId).group(groupItem.key).deleteWidget(key);
    };
    const enterEditMode = (field) => {
        setEditModalData({ isOpen: true, field });
    };
    return (<react_1.Fragment>
      <ListItem_1.default item={groupItem} widget={widget} draggableId={draggableId} renderFieldAccessor={(key) => `data.${groupItem.key}.[...]`} {...rest} CustomEditElements={[
            <theme_ui_1.Button key={`custom-edit-element-${groupItem.key}`} mr={2} variant="buttons.darkSmall" onClick={() => setSelectMode(true)}>
            Add Field
          </theme_ui_1.Button>,
        ]} children={<theme_ui_1.Box sx={{ ml: 4 }}>
            <react_beautiful_dnd_1.DragDropContext onDragEnd={onDragEnd}>
              <react_beautiful_dnd_1.Droppable droppableId={`${tabId}-${groupItem.key}-zone`}>
                {(provided) => (<ul ref={provided.innerRef} {...provided.droppableProps}>
                    {groupItem.value.config.fields.map((item, index) => {
                    const { value: { config, type }, } = item;
                    const widget = utils_2.findWidgetByConfigOrType(Widgets, config, type);
                    if (!widget) {
                        return null;
                    }
                    const props = {
                        item,
                        index,
                        widget,
                        key: item.key,
                        enterEditMode,
                        deleteItem: onDeleteItem,
                        renderFieldAccessor: (key) => `data.${groupItem.key}.${key}`,
                        draggableId: `group-${groupItem.key}-${item.key}-${index}`,
                    };
                    const HintElement = (<Hints_1.default item={item} show={showHints} isRepeatable={isRepeatable} renderHintBase={({ item }) => `data.${groupItem.key}${str_1.transformKeyAccessor(item.key)}`} framework={framework} Widgets={Widgets} typeName={widget.CUSTOM_NAME || widget.TYPE_NAME}/>);
                    return (<ListItem_1.default {...props} HintElement={HintElement}/>);
                })}
                    {provided.placeholder}

                    {newFieldData && (<NewField_1.default {...newFieldData} fields={groupItem.value.config.fields || []} onSave={(...args) => {
                        onSaveNewField(...args);
                        setNewFieldData(null);
                    }} onCancelNewField={onCancelNewField}/>)}
                  </ul>)}
              </react_beautiful_dnd_1.Droppable>
            </react_beautiful_dnd_1.DragDropContext>
          </theme_ui_1.Box>}/>
      <SelectFieldTypeModal_1.default data={{ isOpen: selectMode }} close={() => setSelectMode(false)} onSelect={onSelectFieldType} widgetsArray={sliceBuilderArray_1.default}/>
      <EditModal_1.default Model={Model} data={editModalData} close={closeEditModal} onSave={onSaveField} fields={groupItem.value.config.fields} getFieldMockConfig={getFieldMockConfig}/>
    </react_1.Fragment>);
};
exports.default = CustomListItem;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9saWIvbW9kZWxzL2NvbW1vbi93aWRnZXRzL0dyb3VwL0xpc3RJdGVtL2luZGV4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLGlDQUEyQztBQUUzQyw2REFBaUU7QUFFakUsdUNBQXVDO0FBRXZDLHNDQUE2RTtBQUU3RSxvQ0FBa0Q7QUFFbEQscUdBQTZFO0FBQzdFLGtHQUEwRTtBQUMxRSwrRUFBdUQ7QUFFdkQsMkNBQTJEO0FBRTNELG9FQUFzRDtBQUN0RCw4REFBcUU7QUFFckUscUdBQTZFO0FBRTdFLDRGQUFtRTtBQUVuRSxvRUFBNEM7QUFFNUMsTUFBTSxjQUFjLEdBQUcsQ0FBQyxFQUN0QixLQUFLLEVBQ0wsS0FBSyxFQUNMLEtBQUssRUFDTCxNQUFNLEVBRU4sY0FBYyxFQUNkLFNBQVMsRUFDVCxTQUFTLEVBQ1QsWUFBWSxFQUNaLElBQUksRUFBRSxTQUFTLEVBQ2YsV0FBVyxFQUVYLG1CQUFtQixFQUNuQixHQUFHLElBQUksRUFDUixFQUFFLEVBQUU7SUFDSCxNQUFNLENBQUMsVUFBVSxFQUFFLGFBQWEsQ0FBQyxHQUFHLGdCQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDcEQsTUFBTSxDQUFDLFlBQVksRUFBRSxlQUFlLENBQUMsR0FBRyxnQkFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3ZELE1BQU0sQ0FBQyxhQUFhLEVBQUUsZ0JBQWdCLENBQUMsR0FBRyxnQkFBUSxDQUFDLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7SUFFdEUsTUFBTSxpQkFBaUIsR0FBRyxDQUFDLGNBQWMsRUFBRSxFQUFFO1FBRTNDLGVBQWUsQ0FBQyxFQUFFLGNBQWMsRUFBRSxDQUFDLENBQUM7UUFDcEMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3ZCLENBQUMsQ0FBQztJQUVGLE1B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