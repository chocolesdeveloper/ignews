"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const cors_1 = __importDefault(require("cors"));
require("@babel/register");
console.log("\nLaunching server...");
const os_1 = __importDefault(require("os"));
const path_1 = __importDefault(require("path"));
const express_1 = __importDefault(require("express"));
const body_parser_1 = __importDefault(require("body-parser"));
const serve_static_1 = __importDefault(require("serve-static"));
const express_form_data_1 = __importDefault(require("express-form-data"));
const express_http_proxy_1 = __importDefault(require("express-http-proxy"));
const node_fetch_1 = __importDefault(require("node-fetch"));
const resolveAliases_1 = require("../../lib/env/resolveAliases");
global.fetch = node_fetch_1.default;
global.appRoot = path_1.default.join(__dirname, "../../../");
resolveAliases_1.resolveAliases(global.appRoot);
const api_1 = __importDefault(require("./api"));
const app = express_1.default();
app.use(cors_1.default());
app.use(body_parser_1.default.json({ limit: "64mb" }));
app.use(body_parser_1.default.urlencoded({ extended: true }));
const out = path_1.default.join(__dirname, "../../..", "out");
const formDataOptions = {
    uploadDir: os_1.default.tmpdir(),
};
app.use(express_form_data_1.default.parse(formDataOptions));
app.use("/api", api_1.default);
if (process.env.ENV === "SM") {
    app.use(express_http_proxy_1.default("localhost:3000"));
}
else {
    app.use(serve_static_1.default(out));
}
app.use("/migration", (_, res) => {
    res.sendFile(path_1.default.join(out, "migration.html"));
});
app.use("/changelog", (_, res) => {
    res.sendFile(path_1.default.join(out, "changelog.html"));
});
app.use("/warnings", (_, res) => {
    res.sendFile(path_1.default.join(out, "warnings.html"));
});
app.use("/:lib/:sliceName/:variation/simulator", (_, res) => {
    res.sendFile(path_1.default.join(out, "[lib]/[sliceName]/[variation]/simulator.html"));
});
app.use("/:lib/:sliceName/:variation", (_, res) => {
    res.sendFile(path_1.default.join(out, "[lib]/[sliceName]/[variation].html"));
});
app.use("/:cts/:id", (_, res) => {
    res.sendFile(path_1.default.join(out, "cts/[ct].html"));
});
app.use("/slices", (_, res) => {
    res.sendFile(path_1.default.join(out, "slices.html"));
});
app.use("/onboarding", (_, res) => {
    res.sendFile(path_1.default.join(out, "onboarding.html"));
});
const PORT = process.env.PORT || "9999";
app.use((err, _req, res, _next) => {
    console.error(err);
    res.status(500).send(err.message || "Something broke!");
});
app.listen(PORT, () => {
    const p = `http://localhost:${PORT}`;
    console.log(`Server running : ${p}`);
});
process.on("SIGINT", () => {
    console.log("\nServer killed manually. Exiting...");
    process.exit();
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zZXJ2ZXIvc3JjL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsZ0RBQXdCO0FBRXhCLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBRTNCLE9BQU8sQ0FBQyxHQUFHLENBQUMsdUJBQXVCLENBQUMsQ0FBQztBQUVyQyw0Q0FBb0I7QUFDcEIsZ0RBQXdCO0FBQ3hCLHNEQUE4QjtBQUM5Qiw4REFBcUM7QUFDckMsZ0VBQXVDO0FBQ3ZDLDBFQUF5QztBQUN6Qyw0RUFBdUM7QUFDdkMsNERBQStCO0FBQy9CLGlFQUE4RDtBQVM5RCxNQUFNLENBQUMsS0FBSyxHQUFHLG9CQUFLLENBQUM7QUFDckIsTUFBTSxDQUFDLE9BQU8sR0FBRyxjQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxXQUFXLENBQUMsQ0FBQztBQUVuRCwrQkFBYyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUUvQixnREFBd0I7QUFFeEIsTUFBTSxHQUFHLEdBQUcsaUJBQU8sRUFBRSxDQUFDO0FBQ3RCLEdBQUcsQ0FBQyxHQUFHLENBQUMsY0FBSSxFQUFFLENBQUMsQ0FBQztBQUNoQixHQUFHLENBQUMsR0FBRyxDQUFDLHFCQUFVLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQztBQUM1QyxHQUFHLENBQUMsR0FBRyxDQUFDLHFCQUFVLENBQUMsVUFBVSxDQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztBQUVuRCxNQUFNLEdBQUcsR0FBRyxjQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxVQUFVLEVBQUUsS0FBSyxDQUFDLENBQUM7QUFFcEQsTUFBTSxlQUFlLEdBQUc7SUFDdEIsU0FBUyxFQUFFLFlBQUUsQ0FBQyxNQUFNLEVBQUU7Q0FDdkIsQ0FBQztBQUVGLEdBQUcsQ0FB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