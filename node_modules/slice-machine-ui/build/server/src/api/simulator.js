"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const core_1 = require("@slicemachine/core");
const utils_1 = require("@lib/utils");
const Framework_1 = require("@slicemachine/core/build/models/Framework");
const node_utils_1 = require("@slicemachine/core/build/node-utils");
const { PREVIOUS_REACT_PACKAGE_NAME, NEXT_SLICEZONE, SLICE_SIMULATOR_REACT, PRISMIC_REACT_PACKAGE_NAME, PRISMIC_HELPERS, SLICE_SIMULATOR_VUE, NUXT_PRISMIC, NUXT_SM, VUE_SLICEZONE, } = core_1.CONSTS;
function requiredDepsForFramework(framework) {
    const previousNext = [
        PREVIOUS_REACT_PACKAGE_NAME,
        NEXT_SLICEZONE,
        SLICE_SIMULATOR_REACT,
    ];
    const next = [
        PRISMIC_REACT_PACKAGE_NAME,
        SLICE_SIMULATOR_REACT,
        PRISMIC_HELPERS,
    ];
    const nuxt = [SLICE_SIMULATOR_VUE, NUXT_PRISMIC];
    const previousNuxt = [
        SLICE_SIMULATOR_VUE,
        NUXT_SM,
        VUE_SLICEZONE,
        NUXT_PRISMIC,
    ];
    if (framework === Framework_1.Frameworks.next)
        return next;
    if (framework === Framework_1.Frameworks.previousNext)
        return previousNext;
    if (framework === Framework_1.Frameworks.nuxt)
        return nuxt;
    if (framework === Framework_1.Frameworks.previousNuxt)
        return previousNuxt;
    return [];
}
async function handler(req) {
    const cwd = process.env.CWD || process.cwd();
    const response = {
        manifest: "ok",
        dependencies: "ok",
    };
    if (!utils_1.simulatorIsSupported(req.env.framework)) {
        const message = "[api/env]: Unrecoverable error. The framework doesn't support the preview. Exiting..";
        console.error(message);
        throw new Error(message);
    }
    if (!req.env.manifest.localSliceSimulatorURL) {
        response.manifest = "ko";
    }
    const packageJson = node_utils_1.retrieveJsonPackage(cwd);
    if (!packageJson.exists || !packageJson.content) {
        const message = "[api/env]: Unrecoverable error. Could not find package.json. Exiting..";
        console.error(message);
        throw new Error(message);
    }
    const { dependencies, devDependencies } = packageJson.content;
    const deps = { ...dependencies, ...devDependencies };
    const requiredDeps = requiredDepsForFramework(req.env.framework);
    Object.keys(deps).forEach((dep) => {
        const depIndex = requiredDeps.indexOf(dep);
        if (-1 !== depIndex) {
            requiredDeps.splice(depIndex, 1);
        }
    });
    if (requiredDeps.length !== 0) {
        response.dependencies = "ko";
    }
    return response;
}
exports.default = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2ltdWxhdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc2VydmVyL3NyYy9hcGkvc2ltdWxhdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNkNBQTRDO0FBQzVDLHNDQUFrRDtBQUVsRCx5RUFBdUU7QUFFdkUsb0VBQTBFO0FBRTFFLE1BQU0sRUFDSiwyQkFBMkIsRUFDM0IsY0FBYyxFQUNkLHFCQUFxQixFQUNyQiwwQkFBMEIsRUFDMUIsZUFBZSxFQUNmLG1CQUFtQixFQUNuQixZQUFZLEVBQ1osT0FBTyxFQUNQLGFBQWEsR0FDZCxHQUFHLGFBQU0sQ0FBQztBQUVYLFNBQVMsd0JBQXdCLENBQUMsU0FBcUI7SUFDckQsTUFBTSxZQUFZLEdBQUc7UUFDbkIsMkJBQTJCO1FBQzNCLGNBQWM7UUFDZCxxQkFBcUI7S0FDdEIsQ0FBQztJQUVGLE1BQU0sSUFBSSxHQUFHO1FBQ1gsMEJBQTBCO1FBQzFCLHFCQUFxQjtRQUNyQixlQUFlO0tBQ2hCLENBQUM7SUFFRixNQUFNLElBQUksR0FBRyxDQUFDLG1CQUFtQixFQUFFLFlBQVksQ0FBQyxDQUFDO0lBRWpELE1BQU0sWUFBWSxHQUFHO1FBQ25CLG1CQUFtQjtRQUNuQixPQUFPO1FBQ1AsYUFBYTtRQUNiLFlBQVk7S0FDYixDQUFDO0lBRUYsSUFBSSxTQUFTLEtBQUssc0JBQVUsQ0FBQyxJQUFJO1FBQUUsT0FBTyxJQUFJLENBQUM7SUFDL0MsSUFBSSxTQUFTLEtBQUssc0JBQVUsQ0FBQyxZQUFZO1FBQUUsT0FBTyxZQUFZLENBQUM7SUFDL0QsSUFBSSxTQUFTLEtBQUssc0JBQVUsQ0FBQyxJQUFJO1FBQUUsT0FBTyxJQUFJLENBQUM7SUFDL0MsSUFBSSxTQUFTLEtBQUssc0JBQVUsQ0FBQyxZQUFZO1FBQUUsT0FBTyxZQUFZLENBQUM7SUFFL0QsT0FBTyxFQUFFLENBQUM7QUFDWixDQUFDO0FBR2MsS0FBSyxVQUFVLE9BQU8sQ0FDbkMsR0FBbUI7SUFFbkIsTUFBTSxHQUFHLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQzdDLE1BQU0sUUFBUSxHQUEyQjtRQUN2QyxRQUFRLEVBQUUsSUFBSTtRQUNkLFlBQVksRUFBRSxJQUFJO0tBQ25CLENBQUM7SUFFRixJQUFJLENBQUMsNEJBQW9CLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsRUFBRTtRQUM1QyxNQUFNLE9BQU8sR0FDWCxzRkFBc0YsQ0FBQztRQUN6RixPQUFPLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3ZCLE1BQU0sSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7S0FDMUI7SUFFRCxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsc0JBQXNCLEVBQUU7UUFDNUMsUUFBUSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7S0FDMUI7SUFFRCxNQUFNLFdBQVcsR0FBRyxnQ0FBbUIsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUU3QyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUU7UUFDL0MsTUFBTSxPQUFPLEdBQ1gsd0VBQXdFLENBQUM7UUFDM0UsT0FBTyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN2QixNQUFNLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0tBQzFCO0lBR0QsTUFBTSxFQUFFLFlBQVksRUFBRSxlQUFlLEVBQUUsR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDO0lBRTlELE1BQU0sSUFBSSxHQUEyQixFQUFFLEdBQUcsWUFBWSxFQUFFLEdBQUcsZUFBZSxFQUFFLENBQUM7SUFFN0UsTUFBTSxZQUFZLEdBQUcsd0JBQXdCLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUVqRSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQVcsRUFBRSxFQUFFO1FBQ3hDLE1BQU0sUUFBUSxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDM0MsSUFBSSxDQUFDLENBQUMsS0FBSyxRQUFRLEVBQUU7WUFDbkIsWUFBWSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDbEM7SUFDSCxDQUFDLENBQUMsQ0FBQztJQUVILElBQUksWUFBWSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7UUFDN0IsUUFBUSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7S0FDOUI7SUFFRCxPQUFPLFFBQVEsQ0FBQztBQUNsQixDQUFDO0FBaERELDBCQWdEQyJ9