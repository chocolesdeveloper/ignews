"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const path_1 = __importDefault(require("path"));
const ejs_1 = __importDefault(require("ejs"));
const files_1 = __importDefault(require("@lib/utils/files"));
const paths_1 = require("@lib/models/paths");
const core_1 = require("@slicemachine/core");
const str_1 = require("@lib/utils/str");
const Paths = {
    nuxtTemplate: (appRoot) => path_1.default.join(appRoot, "templates/storybook/nuxt.template.ejs"),
    nextTemplate: (appRoot) => path_1.default.join(appRoot, "templates/storybook/next.template.ejs"),
    svelteTemplate: (appRoot) => path_1.default.join(appRoot, "templates/storybook/svelte.template.ejs"),
    getTemplate(appRoot, framework) {
        switch (framework) {
            case core_1.Models.Frameworks.nuxt:
            case core_1.Models.Frameworks.previousNuxt:
                return Paths.nuxtTemplate(appRoot);
            case core_1.Models.Frameworks.vue:
                return Paths.nuxtTemplate(appRoot);
            case core_1.Models.Frameworks.next:
            case core_1.Models.Frameworks.previousNext:
                return Paths.nextTemplate(appRoot);
            case core_1.Models.Frameworks.react:
                return Paths.nextTemplate(appRoot);
            case core_1.Models.Frameworks.svelte:
                return Paths.svelteTemplate(appRoot);
            case core_1.Models.Frameworks.vanillajs:
                return Paths.nextTemplate(appRoot);
            default:
                return null;
        }
    },
};
exports.default = {
    generateStories(appRoot, framework, cwd, libraryName, sliceName) {
        if (files_1.default.exists(paths_1.CustomPaths(cwd).library(libraryName).slice(sliceName).stories()))
            return;
        const generatedMocksPath = paths_1.GeneratedPaths(cwd)
            .library(libraryName)
            .slice(sliceName)
            .mocks();
        const customMocksPath = paths_1.CustomPaths(cwd)
            .library(libraryName)
            .slice(sliceName)
            .mocks();
        const mocks = files_1.default.readFirstOf([
            customMocksPath,
            generatedMocksPath,
        ])((value) => JSON.parse(value));
        if (!mocks) {
            console.error(`No mocks available, cannot generate stories`);
            return;
        }
        const templatePath = Paths.getTemplate(appRoot, framework);
        if (!templatePath) {
            console.error(`We don't support storybook generated stories for ${framework} yet`);
            return;
        }
        const template = files_1.default.readString(templatePath);
        const withPascalizedIds = (mocks.value || []).map((m) => {
            const id = str_1.createStorybookId(m.variation || m.name);
            return {
                ...m,
                id,
            };
        });
        const componentPath = path_1.default
            .join("..", path_1.default.relative(paths_1.GeneratedPaths(cwd).library(libraryName).value(), paths_1.CustomPaths(cwd).library(libraryName).value()), sliceName)
            .split(path_1.default.sep)
            .join(path_1.default.posix.sep);
        const componentTitle = `${libraryName}/${sliceName}`;
        const stories = ejs_1.default.render(template, {
            mocks: withPascalizedIds,
            componentPath,
            componentTitle,
        });
        files_1.default.write(paths_1.GeneratedPaths(cwd)
            .library(libraryName)
            .slice(sliceName)
            .stories(framework === core_1.Models.Frameworks.svelte
            ? "index.stories.svelte"
            : undefined), stories);
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3Rvcnlib29rLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc2VydmVyL3NyYy9hcGkvc3Rvcnlib29rLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsZ0RBQXdCO0FBQ3hCLDhDQUFpQztBQUVqQyw2REFBcUM7QUFDckMsNkNBQWdFO0FBQ2hFLDZDQUE0QztBQUU1Qyx3Q0FBbUQ7QUFFbkQsTUFBTSxLQUFLLEdBQUc7SUFDWixZQUFZLEVBQUUsQ0FBQyxPQUFlLEVBQUUsRUFBRSxDQUNoQyxjQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSx1Q0FBdUMsQ0FBQztJQUM3RCxZQUFZLEVBQUUsQ0FBQyxPQUFlLEVBQUUsRUFBRSxDQUNoQyxjQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSx1Q0FBdUMsQ0FBQztJQUM3RCxjQUFjLEVBQUUsQ0FBQyxPQUFlLEVBQUUsRUFBRSxDQUNsQyxjQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSx5Q0FBeUMsQ0FBQztJQUMvRCxXQUFXLENBQUMsT0FBZSxFQUFFLFNBQTRCO1FBQ3ZELFFBQVEsU0FBUyxFQUFFO1lBQ2pCLEtBQUssYUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUM7WUFDNUIsS0FBSyxhQUFNLENBQUMsVUFBVSxDQUFDLFlBQVk7Z0JBQ2pDLE9BQU8sS0FBSyxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNyQyxLQUFLLGFBQU0sQ0FBQyxVQUFVLENBQUMsR0FBRztnQkFDeEIsT0FBTyxLQUFLLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3JDLEtBQUssYUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUM7WUFDNUIsS0FBSyxhQUFNLENBQUMsVUFBVSxDQUFDLFlBQVk7Z0JBQ2pDLE9BQU8sS0FBSyxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNyQyxLQUFLLGFBQU0sQ0FBQyxVQUFVLENBQUMsS0FB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